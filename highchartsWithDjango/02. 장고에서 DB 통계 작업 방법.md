# 장고에서 csv 파일을 DB로 적재하는 방법

- 상황
  - 데이터: [titanic.csv](https://github.com/sibtc/django-highcharts-example) 파일 내용을 확인하려면 [클릭](https://github.com/sibtc/django-highcharts-example/blob/master/titanic.csv)
  - 이 csv 데이터를 장고 DB 내부로 적재해야 함
  - 장고 소스 코드를 복사하고,
    필요한 패키지를 설치한 후,
    마이그레이트 작업을 수행하면 데이터가 장고 DB로 적재되도록 함
```
$ git clone https://github.com/sibtc/django-highcharts-example.git
$ pip install -r requirements.txt
$ python manage.py migrate
$ python manage.py runserver
```
- 개요
  - 장고 프로젝트 생성하고,
    DB 초기화 실행하고,
    장고 앱 생성하고,
    앱 모델 코드 작성하고,
    마이그레이션 준비 작업까지 실행한 후,
    앱 하위 migrations 폴더 내부에
    `0002_xxx.py` 파일에 populating 코드를 작성
  - settings.py
    - INSTALLED_APPS += 'passengers'
    - TEMPLATES['DIRS'] = [os.path.join(BASE_DIR, 'templates'), ]
- 쉬운 실행 방법
  - 대안 1) 복제한 소스 코드에서 'passengers/migrations/0002_xxx.py' 파일을 제거하고,
    작업 진행
  - 대안 2) 새로 만든 프로젝트 폴더와 복제 폴더를 `winmerge`로 비교하면서 작업 진행
  - 두 대안 중에서 하나로 작업 진행 후, 개발 서버 기동하여 http://127.0.0.1:8000/
 브라우즈
- passengers/migrations/0002_auto_populating.py
```python {.line-numbers}
import csv
import os

from django.db import migrations
from django.conf import settings

# csv 파일의 해당 열 번호를 상수로 정의
TICKET_CLASS = 0  # 승차권 등급
SURVIVED = 1      # 생존 여부
NAME = 2          # 이름
SEX = 3           # 성별
AGE = 4           # 나이
EMBARKED = 10     # 탑승지

def add_passengers(apps, schema_editor):
    Passenger = apps.get_model('passengers', 'Passenger')  # app_label, model_name
    titanic_dataset_file = os.path.join(settings.BASE_DIR, 'titanic.csv')
    with open(titanic_dataset_file) as dataset:     # 파일 객체 dataset
        reader = csv.reader(dataset)                    # 파일 객체 dataset에 대한 반복적 판독기 획득
        next(reader)  # ignore first row (headers)      # __next__() 호출 때마다 한 라인 판독
        for entry in reader:                            # 판독기에 대하여 반복 처리
            Passenger.objects.create(                       # DB 행 생성
                name=entry[NAME],
                sex='M' if entry[SEX] == 'male' else 'F',
                survived=bool(int(entry[SURVIVED])),        # int()로 변환하고, 다시 bool()로 변환
                age=float(entry[AGE]) if entry[AGE] else 0.0,
                ticket_class=int(entry[TICKET_CLASS]),      # int()로 변환
                embarked=entry[EMBARKED],
            )

class Migration(migrations.Migration):
    dependencies = [                            # 선행 관계
        ('passengers', '0001_initial'),         # app_label, preceding migration file
    ]
    operations = [                              # 작업
        migrations.RunPython(add_passengers),   # add_passengers 함수를 호출
    ]
```
