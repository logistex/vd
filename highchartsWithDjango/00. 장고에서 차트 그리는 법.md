# 장고에서 차트 그리는 법

- [How to Integrate Highcharts.js with Django by Vitor Freitas, 180403](https://simpleisbetterthancomplex.com/tutorial/2018/04/03/how-to-integrate-highcharts-js-with-django.html)

- 핵심 과제
    - 백엔드에서 공급되는 데이터를 'Highcharts'가 이해하는 형식으로 전환하는 방법
    - 백엔드 데이터는 DB 또는 외부 API에서 제공되며, (QuerySet, 사전 혹은 리스트와 같은) 파이썬 객체 형태
- 두 방법
    - request/response 주기를 통하여, 템플릿 내부에 자바스크립트 코드를 파이썬 또는 장고 템플릿 엔진을 통하여 작성
    - AJAX를 이용하는 비동기 request를 통하여, 데이터를 JSON 형식으로 반환

### 1. 설치/준비
- 장고 설치
```
$ conda activate vnv_vd
$ conda install django          # 장고 설치
$ python -m django --version    # 장고 버전 확인 2.2.5
```
- Highcharts 설치
    - Highcharts 라이브러리를 우리의 템플릿에 포함시켜야 하는데,
    - 직접 [다운로드](https://www.highcharts.com/download)해서 포함시키는 방법
    - CDN을 활용하는 방법
 ```
 <script src="https://code.highcharts.com/highcharts.src.js"></script>
 ```

### 2. 활용 시나리오
   - 차트 작성에 활용할 데이터가 필요함
   - Titanic 데이터셋 [RMS Titanic tragedy](https://en.wikipedia.org/wiki/RMS_Titanic)
   - (1300명 이상의) Passenger 모델
```Python {.line-numbers}
class Passenger(models.Model):
    name = models.CharField()
    sex = models.CharField()
    survived = models.BooleanField()
    age = models.FloatField()
    ticket_class = models.PositiveSmallIntegerField()
    embarked = models.CharField()
```

### 3. Highcharts 기본
- 장고와 하이차트의 통신 방법을 익히는 것이 핵심
- 하이차트 [공식 문서](https://www.highcharts.com/docs)
```HTML {.line-numbers}
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Django Highcharts Example</title>
</head>
<body>
  <div id="container"></div>
  <script src="https://code.highcharts.com/highcharts.src.js"></script>
  <script>
    Highcharts.chart('container', {
        chart: {
            type: 'column'
        },
        title: {
            text: 'Historic World Population by Region'
        },
        xAxis: {
            categories: ['Africa', 'America', 'Asia', 'Europe', 'Oceania']
        },
        series: [{
            name: 'Year 1800',
            data: [107, 31, 635, 203, 2]
        }, {
            name: 'Year 1900',
            data: [133, 156, 947, 408, 6]
        }, {
            name: 'Year 2012',
            data: [1052, 954, 4250, 740, 38]
        }]
    });
  </script>
</body>
</html>
```
![](https://simpleisbetterthancomplex.com/media/2018/04/highcharts-column-chart.png)
- 기본 구조
```
Highcharts.chart('id_of_the_container', {
  // dictionary of options/configuration
});
```
### 4. 기본 예제
- 템플릿 내부에 직접 코드를 작성하는 방식(비추!)
- 승선 티켓 등급에 따른 사망자와 생존자 수를 출력하는 쿼리를 작성
##### 방법 1
- views.py
```Python {.line-numbers}
from django.db.models import Count, Q
from django.shortcuts import render
from .models import Passenger

def ticket_class_view(request):
    dataset = Passenger.objects \
        .values('ticket_class') \
        .annotate(survived_count=Count('ticket_class', filter=Q(survived=True)),
                  not_survived_count=Count('ticket_class', filter=Q(survived=False))) \
        .order_by('ticket_class')
    return render(request, 'ticket_class.html', {'dataset': dataset})
```
위 코드가 생성하는 queryset은 다음 형식의 데이터를 제공함
```Python {.line-numbers}
[
  {'ticket_class': 1, 'survived_count': 200, 'not_survived_count': 123},
  {'ticket_class': 2, 'survived_count': 119, 'not_survived_count': 158},
  {'ticket_class': 3, 'survived_count': 181, 'not_survived_count': 528}
]
```
- ticket_class.html
  템플릿에서 자바스크립트 태그 내부에 이를 작성
```HTML {.line-numbers}
<div id="container"></div>
<script src="https://code.highcharts.com/highcharts.src.js"></script>
<script>
  Highcharts.chart('container', {
      chart: {
          type: 'column'
      },
      title: {
          text: 'Titanic Survivors by Ticket Class'
      },
      xAxis: {
          categories: [
            {% for entry in dataset %}'
                {{ entry.ticket_class }} Class'{% if not forloop.last %}, {% endif %}
            {% endfor %}
          ]
      },
      series: [{
          name: 'Survived',
          data: [
            {% for entry in dataset %}
                {{ entry.survived_count }}{% if not forloop.last %}, {% endif %}
            {% endfor %}
          ],
          color: 'green'
      }, {
          name: 'Not survived',
          data: [
            {% for entry in dataset %}
                {{ entry.not_survived_count }}{% if not forloop.last %}, {% endif %}
            {% endfor %}
          ],
          color: 'red'
      }]
  });
</script>
```
![](https://simpleisbetterthancomplex.com/media/2018/04/survivors-by-class.png)
- 이런 방법은 좋은 방식이 아님
- 더 좋은 방법은 뷰에서 데이터를 처리하는 방식
##### 방법 2
- views.py
```Python {.line-numbers}
import json
from django.db.models import Count, Q
from django.shortcuts import render
from .models import Passenger

def ticket_class_view_2(request):
    dataset = Passenger.objects \
        .values('ticket_class') \
        .annotate(survived_count=Count('ticket_class', filter=Q(survived=True)),
                  not_survived_count=Count('ticket_class', filter=Q(survived=False))) \
        .order_by('ticket_class')

    # 리스트 3종 준비
    categories = list()
    survived_series = list()
    not_survived_series = list()

    # 리스트 3종에 형식화된 값을 등록
    for entry in dataset:
        categories.append('%s Class' % entry['ticket_class'])
        survived_series.append(entry['survived_count'])
        not_survived_series.append(entry['not_survived_count'])

    # json.dumps() 함수로 리스트 3종을 JSON 데이터 형식으로 반환
    return render(request, 'ticket_class_2.html', {
        'categories': json.dumps(categories),
        'survived_series': json.dumps(survived_series),
        'not_survived_series': json.dumps(not_survived_series)
    })
```
- ticket_class_2.html
  - `categories`를 바르게 렌더하기 위하여 `safe` 템플릿 필터를 적용하였음
    - 장고는 보안을 위하여 자동적으로 `'` 및 `"` 등의 문자를 이스케이프 처리함
    - 장고에게 내가 작성한 코드를 신뢰하고 있는 그대로 렌더하라고 지시
```HTML {.line-numbers}
<div id="container"></div>
<script src="https://code.highcharts.com/highcharts.src.js"></script>
<script>
  Highcharts.chart('container', {
      chart: {
          type: 'column'
      },
      title: {
          text: 'Titanic Survivors by Ticket Class'
      },
      xAxis: {
          categories: {{ categories|safe }}  /* safe 필터 */
      },
      series: [{
          name: 'Survived',
          data: {{ survived_series }},
          color: 'green'
      }, {
          name: 'Not survived',
          data: {{ not_survived_series }},
          color: 'red'
      }]
  });
</script>
```
- 이 모든 작업을 백엔드에서 처리할 수도 있음
##### 방법 3
- views.py

```Python {.line-numbers}
import json
from django.db.models import Count, Q
from django.shortcuts import render
from .models import Passenger

def ticket_class_view_3(request):
    dataset = Passenger.objects \
        .values('ticket_class') \
        .annotate(survived_count=Count('ticket_class', filter=Q(survived=True)),
                  not_survived_count=Count('ticket_class', filter=Q(survived=False))) \
        .order_by('ticket_class')

    categories = list()
    survived_series_data = list()
    not_survived_series_data = list()

    for entry in dataset:
        categories.append('%s Class' % entry['ticket_class'])
        survived_series_data.append(entry['survived_count'])
        not_survived_series_data.append(entry['not_survived_count'])

    survived_series = {
        'name': 'Survived',
        'data': survived_series_data,
        'color': 'green'
    }

    not_survived_series = {
        'name': 'Survived',
        'data': not_survived_series_data,
        'color': 'red'
    }

    chart = {
        'chart': {'type': 'column'},
        'title': {'text': 'Titanic Survivors by Ticket Class'},
        'xAxis': {'categories': categories},
        'series': [survived_series, not_survived_series]
    }

    dump = json.dumps(chart)

    return render(request, 'ticket_class_3.html', {'chart': dump})
```
- ticket_class_3.html
```HTML {.line-numbers}
<div id="container"></div>
<script src="https://code.highcharts.com/highcharts.src.js"></script>
<script>
  Highcharts.chart('container', {{ chart|safe }});
</script>
```
### 5. JSON 예제
- highcharts 및 기타 서버와 상호작용하는 자바스크립트 라이브러리를 활용할 때 추천하는 방식
- 차트를 렌더할 때 비동기 호출을 사용하고, 서버에서 `JsonResponse`를 반환하는 방식
- urls.py
  접속 경로 2종
```Python {.line-numbers}
from django.urls import path

from passengers import views

urlpatterns = [
    path('json-example/', views.json_example, name='json_example'),
    path('json-example/data/', views.chart_data, name='chart_data'),
]
```
- views.py
  - `json_example`은 단순히 `json_example.html`을 반환
  - `chart_data`은 모든 힘든 일을 담당
    - 데이터베이스 조회
    - `chart` 사전 구성
```Python {.line-numbers}
def json_example(request):
    return render(request, 'json_example.html')

def chart_data(request):
    dataset = Passenger.objects \
        .values('embarked') \
        .exclude(embarked='') \
        .annotate(total=Count('embarked')) \
        .order_by('embarked')

    port_display_name = dict()
    for port_tuple in Passenger.PORT_CHOICES:
        port_display_name[port_tuple[0]] = port_tuple[1]

    chart = {
        'chart': {'type': 'pie'},
        'title': {'text': 'Titanic Survivors by Ticket Class'},
        'series': [{
            'name': 'Embarkation Port',
            'data': list(map(lambda row: {'name': port_display_name[row['embarked']], 'y': row['total']}, dataset))
        }]
    }

    return JsonResponse(chart)
```
- json_example.html
  - `div#container`이 차트가 그려질 영역
  - `data-url="{% url 'chart_data' %}"` 부분을 보면,
      - 결국 'chart_data'라는 이름의 접속경로로 연결되고,
      - 최종적으로 views.chart_data() 함수로 연결되어,
      - `JsonResponse(chart)`를 반환하게 됨
  - jQuery `$.ajax()`에 연결됨
    - `dataType`에서 명시한 JSON 객체의 반환을 대기하라는 ajax 요청을 지시함
    - ajax 요청에 대한 응답이 완료되면,
      JSON 응답이 `success` 함수의 `data` 매개변수 내부로 전달됨
    - 최종적으로, `success` 함수 내부에서 Highcharts API를 활용하여 차트를 그리게 됨
```HTML {.line-numbers}
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Django Highcharts Example</title>
</head>
<body>
  <div id="container" data-url="{% url 'chart_data' %}"></div>
  <script src="https://code.highcharts.com/highcharts.src.js"></script>
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script>
    $.ajax({
      url: $("#container").attr("data-url"),
      dataType: 'json',
      success: function (data) {
        Highcharts.chart("container", data);
      }
    });
  </script>
</body>
</html>
```
![](https://simpleisbetterthancomplex.com/media/2018/04/highcharts-pie-chart.png)

### 6. 결론
- `Highcharts.js`와 `Django`의 통합
  - 이러한 통합 방식은 `Charts.js`와 같은 다른 차트 라이브러리에 대하여도 공통적으로 적용됨
  - 장고 템플릿 언어를 활요하여 자바스크립트 코드와 상호작용하는 방식은 바람직하지 않음
  - JSON 객체 형식의 데이터를 반환받아 이를 활용하는 방식을 강추함
- 차트 작성에 적합한 형식으로 데이터를 공급하는 방법
  - 우선, 정적 자료를 하드코딩 하는 방식으로 차트를 그려봄으로써 필요한 데이터 형식을 파악
  - 이후, 파이썬 터미널에서 QuerySet을 작성
  - 최종적으로 뷰 함수를 작성
- 추가 학습 자료
  - [titanic.csv](https://github.com/sibtc/django-highcharts-example/blob/master/titanic.csv) 자료 형식
  - [Passenger model class](https://github.com/sibtc/django-highcharts-example/blob/master/passengers/models.py) 이해
  - [Highcharts.js demo page](https://www.highcharts.com/demo)에서 원하는 차트 형태 선별
  - [django-highcharts-example repository](https://github.com/sibtc/django-highcharts-example) 복제 및 실행
